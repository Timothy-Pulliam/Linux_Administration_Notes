Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2018-08-25T14:22:23-04:00

====== Memory ======
Created Saturday 25 August 2018

==== View Memory Usage of kernel ====
http://www.asgaur.com/wp/high-memory-utilized-by-zfs-file-data-in-solaris/
https://support.hpe.com/hpsc/doc/public/display?docId=emr_na-c03143598
ZFS Adaptive Replacement Cache (ARC) tends to use up to 75% of the installed physical memory on servers with 4GB or less and up to everything except 1GB of memory on servers with more than 4GB of memory to cache data in a bid to improve performance.

'''
[root@host ~]# echo "::memstat" | mdb -k
Page Summary                            Pages             Bytes  %Tot
---------------------------- ----------------  ----------------  ----
Kernel                                 634523              4.8G   15%
ZFS                                   1570411             11.9G   37%
Anon                                  1330743             10.1G   32%
Exec and libs                           79601            621.8M    2%
Page cache                              21262            166.1M    0%
OSM                                     80896              632M    2%
Free (cachelist)                           15              120k    0%
Free (freelist)                        476853              3.6G   11%
Total                                 4194304               32G
'''


'''
ZFS ARC cache is taking up most of the memory. This is expected behavior. Memory will be made available when needed.

-bash-4.1# echo "::arc" | mdb -k|grep size
size                      =        83404 MB
target size (c)           =       127266 MB
target mru_size (p)       =         3192 MB
buf_size                  =          825 MB
data_size                 =        81804 MB
other_size                =          742 MB
rawdata_size              =            0 MB
mfu_size                  =        72376 MB
mru_size                  =         9309 MB
'''


==== Memory usage of processes ====
https://www.sanfoundry.com/vmstat-command-usage-examples-linux/

Sort processes by memory usage (resident set size)
prstat -s rss

# ps -eo pid,pmem,rss,vsz,comm | sort -k 3  

==== High Memory Usage with ZFS ====

https://support.hpe.com/hpsc/doc/public/display?docId=emr_na-c03143598
Sun Solaris 10 - High Memory Consumption Using ZFS
Issue
Missing memory in Solaris 10 with ZFS

Solution
To find precious memory installed on the server:

If running Solaris 10 and use ZFS file system then need to follow:

ZFS Adaptive Replacement Cache (ARC) tends to use up to 75% of the installed physical memory on servers with 4GB or less and up to everything except 1GB of memory on servers with more than 4GB of memory to cache data in a bid to improve performance.

This can significantly affect performance on mission critical servers running databases etc.

To identify how much memory zfs uses:

   ''# kstat -m zfs | grep size'' 
'''
data_size                       18935877120                     hdr_size                        66041496          
l2_hdr_size                     0 
l2_size                         0 
other_size                      11310112 
size                            19013228728
'''
 

Here **19013228728** (approximately 18G) indicate the total memory used by ZFS. Alternatively, the following mdb command shows ZFS ARC usage:

'''
# echo "::arc" | mdb -k|grep size 
size                      =      2048 MB 
hdr_size                  =  12493584 
data_size                 = 2048608256 
other_size                =  86475456 
l2_size                   =         0  
 l2_hdr_size               =         0
'''
 

It makes sense to cap the maximum ZFS ARC can use on servers where memory is required for other services. To set the maximum limit for ZFS ARC, edit **/etc/system** file and add the following line:

''# set zfs:zfs_arc_max=2147483648''   
Wherein, **2147483648** restrict the usage to a maximum of 2GB physical memory. Unfortunately, this requires a reboot for the setting to take effect and cannot be dynamically changed.
